{{ template "head" . }}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12 text-center ">
            <h4>Select the test:</h4> <br/>
            <div id="simulation-links">
            </div>
        </div>
        <div id="json-div" class="col-sm-12 text-center">
            <h5>Export to json (Current test):</h5>
            <div id="json-links">
            </div>
        </div>
    </div>

    <div id="charts" class="row charts">
    </div>

</div>

<script>
    queries = [{
            id: "mailbox-size",
            name: "Mailbox size",
            query: "rate(akka_actor_mailbox_size_sum[{{ .Params.t }}]) / "
                    + "rate(akka_actor_mailbox_size_count[{{ .Params.t }}])",
            classes: "col-sm-12 chart"
        }, {
            id:   "time-in-mailbox",
            name: "time in mailbox",
            units: "seconds",
            query: "rate(akka_actor_time_in_mailbox_seconds_sum[{{ .Params.t }}]) / "
                    + "rate(akka_actor_time_in_mailbox_seconds_count[{{ .Params.t }}])",
            classes: "col-sm-12 chart"
        }, {
            id: "processing-time",
            name: "Actor processing time",
            units: "seconds",
            query: "rate(akka_actor_processing_time_seconds_sum[{{ .Params.t }}]) / "
                    + "rate(akka_actor_processing_time_seconds_count[{{ .Params.t }}])",
            classes: "col-sm-12 chart"
        }, {
            id: "raphtory-benchmarker",
            name: "benchmarker",
            query: "raphtory_benchmarker",
            classes: "col-sm-12 chart"
        }, {
            id: "host-memory",
            name: "Mem usage", 
            units: "Bytes",
            query: "rate(jvm_memory_bytes_sum{measure='used'}[{{ .Params.t }}]) / "
                    + "rate(jvm_memory_bytes_count{measure='used'}[{{ .Params.t }}])",
            classes: "col-sm-12 chart"
        }, {
            id: "host-cpu",
            name: "Cpu usage",
            units: "%",
            query: "rate(process_cpu_sum[{{ .Params.t }}]) / "
                    + "rate(process_cpu_count[{{ .Params.t }}])",
            classes: "col-sm-12 chart"
        }, {
            id: "heap-instances",
            name: "heapInstances",
            units: "instances",
            query: "raphtory_heap_instances",
            classes: "col-sm-6 chart"
        }, {
            id: "heap-memory",
            name: "heapMemory",
            units: "Bytes",
            query: "raphtory_heap_bytes_bytes",
            classes: "col-sm-6 chart"
        }, {
            id: "dead-letters",
            name: "Dead letters",
            query: "akka_system_dead_letters_total",
            classes: "col-sm-12 chart"
        }
    ];


    function generateLink(query) {
        uri = window.location.origin + "/api/v1/query_range?query=" +
        encodeURIComponent(query);
        duration = '3600';
        {{ if .Params.duration }}
            duration = {{ .Params.duration }};
        {{ end }}
        endTime = Math.floor(new Date() / 1000);
        {{ if .Params.endTime }}
            endTime = '{{ .Params.endTime }}';
        {{ end }}
        uri += "&step=1" + "&start=" + 
            (endTime - duration) + "&end=" + endTime;
        return uri;
    }

    function generate(query) {
        var div       = document.createElement('div');
        div.id        = query.id;
        div.className = query.classes;
        document.getElementById("charts").appendChild(div);

        query.rendered = new PromConsole.Graph({
            node: document.querySelector("#" + query.id),
            expr: query.query,
            yAxisFormatter: PromConsole.NumberFormatter.humanizeNoSmallPrefix,
            yHoverFormatter: PromConsole.NumberFormatter.humanizeNoSmallPrefix,
            yUnits: query.units,
            yTitle: query.name,
            {{ if .Params.duration }}duration: '{{ .Params.duration }}',{{ end }}
            {{ if .Params.endTime  }}endTime:  '{{ .Params.endTime  }}'{{ end }}
        })
    }

    function getCSV(id) {
        separator = "\t";

        json = queries[id].rendered.rendered_data[0].data.result;

        datas = json.map(e => e.values.map(data => data[1]));
        datas[datas.length] = json[0].values.map(data => data[0]);

        header= json.map(e => JSON.stringify(e.metric));
        header[header.length] = "time";

        columns = datas.length;
        rows = datas[0].length;

        csv = [];
        csv.push(header.join(separator));

        for (i = 0; i < rows; i++) {
            ret = "";
            for (j = 0; j < columns; j++) {
                ret += datas[j][i] + ((j+1<columns)?separator:"");
            }
            csv.push(ret);
        }
        var hiddenElement = document.createElement('a');

        hiddenElement.href = "data:attachment/text," + encodeURI(csv.join("\n"));
        hiddenElement.target = "_blank";
        hiddenElement.download = queries[id].id + ".csv";
        hiddenElement.click();
        console.log(csv);
    }

    simulations = [
        { name: "latest",              uri: "/consoles/index.html?t=180s"                                   },
        { name: "100 updates/s (21h)", uri: "/consoles/index.html?t=180s&endTime=1522163854&duration=75600" },
    ];


    simulations.forEach(function(e) {
        var a = document.createElement('a');
        var linkText = document.createTextNode(e.name);
        a.appendChild(linkText);
        a.href = window.location.origin + e.uri;
        document.getElementById("simulation-links").appendChild(a);
    });

    {{ if .Params.t }}
        queries.forEach(function(e, i) {
            generate(e);
            document.getElementById("json-links")
                .insertAdjacentHTML('beforeend', '<a href="#" onclick="getCSV(' + i + ')">' +
                        e.name + '</a> -- ');

        });
    {{ end }}

</script>

<style>
    .prom_lhs_menu, .navbar {
        display:none;
    }

    .chart {
        margin-top: 100px;
    }

    body, html {
        overflow-x: hidden;
    }

    #simulation-links a {
        padding: 0 10px;
    }
</style>

{{ template "tail" }}
